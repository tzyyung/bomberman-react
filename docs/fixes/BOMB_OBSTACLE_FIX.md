# 炸彈障礙物修復

## 問題分析

### 炸彈不作為障礙物的原因
1. **地圖格子類型未更新**：炸彈放置時沒有將地圖格子標記為 `BOMB` 類型
2. **玩家移動檢測不正確**：玩家可以移動到炸彈位置
3. **炸彈爆炸時未恢復**：炸彈爆炸時沒有恢復地圖格子類型
4. **踢動炸彈時未更新**：踢動炸彈時沒有正確更新地圖格子類型

### 用戶需求
- **炸彈作為障礙物**：玩家放置炸彈後不能移動到炸彈位置
- **正確的地圖更新**：地圖格子類型正確反映炸彈狀態
- **炸彈爆炸後恢復**：炸彈爆炸後地圖格子恢復為空地
- **踢動炸彈正確**：踢動炸彈時正確更新地圖格子類型

## 解決方案

### 1. 修復炸彈放置邏輯

#### 炸彈放置時更新地圖
```typescript
// 創建新炸彈
const bomb: Bomb = {
  // ... 炸彈屬性
};

console.log(`玩家 ${player.id} 放置炸彈，威力: ${bomb.power}`);

// 更新地圖格子類型為炸彈
map[player.gridY][player.gridX].type = 3; // BOMB

bombs.push(bomb);
player.bombCount++;
player.lastBombTime = Date.now();
```

**修復要點**：
- ✅ **地圖更新**：將地圖格子類型設置為 `BOMB` (3)
- ✅ **位置正確**：使用炸彈的網格位置更新地圖
- ✅ **時機正確**：在炸彈添加到列表之前更新地圖

### 2. 修復炸彈爆炸邏輯

#### 炸彈爆炸時恢復地圖
```typescript
private explodeBomb(bomb: Bomb, bombs: Bomb[], map: MapTile[][], players: Player[]): Array<{x: number, y: number}> {
  bomb.exploded = true;
  
  // 恢復地圖格子類型為空地
  map[bomb.gridY][bomb.gridX].type = 0; // EMPTY
  
  // 減少玩家炸彈計數
  const owner = players.find(p => p.id === bomb.ownerId);
  if (owner) {
    owner.bombCount = Math.max(0, owner.bombCount - 1);
  }
  
  // 創建爆炸效果
  const explosionPositions = this.createExplosion(bomb, map);
  
  // 檢查連鎖爆炸
  this.checkChainExplosion(bomb, bombs, map);
  
  return explosionPositions;
}
```

**修復要點**：
- ✅ **地圖恢復**：將地圖格子類型恢復為 `EMPTY` (0)
- ✅ **位置正確**：使用炸彈的網格位置恢復地圖
- ✅ **時機正確**：在炸彈爆炸時立即恢復地圖

### 3. 修復踢動炸彈邏輯

#### 踢動炸彈時更新地圖
```typescript
// 檢查是否可以移動
if (this.canMoveBombTo(newX, newY, map)) {
  // 恢復原位置的地圖格子類型
  map[bomb.gridY][bomb.gridX].type = 0; // EMPTY
  
  // 更新炸彈位置
  bomb.gridX = newX;
  bomb.gridY = newY;
  bomb.pixelX = newX * TILE_SIZE + TILE_SIZE / 2;
  bomb.pixelY = newY * TILE_SIZE + TILE_SIZE / 2;
  bomb.kickDistance++;
  
  // 更新新位置的地圖格子類型
  map[newY][newX].type = 3; // BOMB
} else {
  bomb.kicked = false;
  bomb.kickDirection = null;
}
```

**修復要點**：
- ✅ **原位置恢復**：將原位置的地圖格子類型恢復為 `EMPTY`
- ✅ **新位置更新**：將新位置的地圖格子類型設置為 `BOMB`
- ✅ **位置同步**：確保炸彈位置和地圖格子類型同步

### 4. 確保玩家移動檢測正確

#### 玩家移動檢測
```typescript
private canMoveTo(x: number, y: number, map: MapTile[][]): boolean {
  if (x < 0 || x >= map[0].length || y < 0 || y >= map.length) {
    return false;
  }
  
  const tile = map[y][x];
  // 只允許移動到空地或道具位置，不允許移動到炸彈位置
  return tile.type === 0 || tile.type === 5; // EMPTY or POWERUP
}
```

**修復要點**：
- ✅ **正確檢測**：只允許移動到 `EMPTY` (0) 或 `POWERUP` (5) 位置
- ✅ **炸彈阻擋**：不允許移動到 `BOMB` (3) 位置
- ✅ **邊界檢查**：確保位置在地圖範圍內

## 技術改進詳情

### 1. 地圖格子類型管理

#### 炸彈放置時
- **地圖更新**：`map[y][x].type = 3` (BOMB)
- **位置同步**：使用炸彈的網格位置
- **時機正確**：在炸彈添加到列表之前

#### 炸彈爆炸時
- **地圖恢復**：`map[y][x].type = 0` (EMPTY)
- **位置同步**：使用炸彈的網格位置
- **時機正確**：在炸彈爆炸時立即恢復

#### 踢動炸彈時
- **原位置恢復**：`map[oldY][oldX].type = 0` (EMPTY)
- **新位置更新**：`map[newY][newX].type = 3` (BOMB)
- **位置同步**：確保炸彈位置和地圖同步

### 2. 玩家移動檢測

#### 移動條件
- **空地**：`tile.type === 0` (EMPTY)
- **道具**：`tile.type === 5` (POWERUP)
- **炸彈**：`tile.type === 3` (BOMB) - 不允許移動

#### 邊界檢查
- **地圖範圍**：確保位置在地圖範圍內
- **類型檢查**：檢查地圖格子的類型
- **移動判斷**：根據格子類型決定是否允許移動

### 3. 炸彈狀態管理

#### 炸彈生命週期
1. **放置**：地圖格子類型設置為 `BOMB`
2. **存在**：地圖格子類型保持為 `BOMB`
3. **踢動**：地圖格子類型跟隨炸彈移動
4. **爆炸**：地圖格子類型恢復為 `EMPTY`

#### 狀態同步
- **炸彈位置**：與地圖格子類型同步
- **玩家移動**：根據地圖格子類型判斷
- **視覺效果**：地圖格子類型影響渲染

## 修復效果

### 炸彈作為障礙物
- ✅ **放置後阻擋**：玩家放置炸彈後不能移動到炸彈位置
- ✅ **地圖更新**：地圖格子類型正確反映炸彈狀態
- ✅ **移動檢測**：玩家移動檢測正確阻止移動到炸彈位置

### 炸彈爆炸後恢復
- ✅ **地圖恢復**：炸彈爆炸後地圖格子恢復為空地
- ✅ **玩家移動**：炸彈爆炸後玩家可以移動到該位置
- ✅ **狀態同步**：地圖狀態與炸彈狀態同步

### 踢動炸彈正確
- ✅ **原位置恢復**：踢動炸彈時原位置恢復為空地
- ✅ **新位置更新**：踢動炸彈時新位置標記為炸彈
- ✅ **移動檢測**：玩家移動檢測正確處理踢動後的炸彈

### 整體功能
- ✅ **炸彈障礙物**：炸彈正確作為障礙物阻止玩家移動
- ✅ **地圖同步**：地圖格子類型與炸彈狀態同步
- ✅ **移動檢測**：玩家移動檢測正確處理所有情況
- ✅ **遊戲機制**：符合經典炸彈人遊戲機制

## 測試建議

### 1. 炸彈放置測試
- **放置炸彈**：檢查地圖格子類型是否更新為 `BOMB`
- **移動阻擋**：檢查玩家是否不能移動到炸彈位置
- **視覺效果**：檢查炸彈是否正確顯示

### 2. 炸彈爆炸測試
- **爆炸觸發**：檢查炸彈是否正確爆炸
- **地圖恢復**：檢查地圖格子類型是否恢復為 `EMPTY`
- **移動恢復**：檢查玩家是否可以移動到爆炸後的位置

### 3. 踢動炸彈測試
- **踢動炸彈**：檢查炸彈是否正確踢動
- **原位置恢復**：檢查原位置是否恢復為空地
- **新位置更新**：檢查新位置是否標記為炸彈
- **移動檢測**：檢查玩家移動檢測是否正確

### 4. 綜合功能測試
- **完整流程**：測試從放置到爆炸的完整流程
- **多個炸彈**：測試多個炸彈的情況
- **踢動移動**：測試踢動炸彈後的移動
- **邊界情況**：測試各種邊界情況

## 結論

通過修復炸彈放置、爆炸和踢動時的地圖格子類型管理，現在炸彈正確作為障礙物：

1. **炸彈放置**：地圖格子類型設置為 `BOMB`，阻止玩家移動
2. **炸彈爆炸**：地圖格子類型恢復為 `EMPTY`，允許玩家移動
3. **踢動炸彈**：地圖格子類型跟隨炸彈移動
4. **玩家移動**：正確檢測地圖格子類型，阻止移動到炸彈位置

現在炸彈正確作為障礙物，符合經典炸彈人遊戲機制！💣🚫
